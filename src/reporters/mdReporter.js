'use strict';

/**
 * @param {object} result  FunMeter.run()ì´ ë°˜í™˜í•œ ê²°ê³¼ ê°ì²´
 * @returns {string}       GFM Markdown ë¬¸ìì—´
 */
function toMarkdown(result) {
  const { name, runs, zone, emoji, advice, mean, median, stddev,
          p25, p75, p90, p95, timeoutRate, scoreMean, scoreMax,
          levelStats, histogram } = result;

  const histLines = histogram.map(function(h) {
    var label = (h.from.toFixed(1) + '~' + h.to.toFixed(1) + 's').padEnd(13);
    var bar = '';
    for (var i = 0; i < h.bar.length; i++) bar += '\u2588';
    bar = bar.padEnd(15);
    return '  ' + label + ' ' + bar + ' (' + h.count + ')';
  }).join('\n');

  const levelSection = levelStats ? [
    '',
    '## ë ˆë²¨',
    '',
    '| í•­ëª© | ê°’ |',
    '|------|----|',
    '| í‰ê·  | ' + levelStats.mean.toFixed(1) + ' |',
    '| ì¤‘ì•™ê°’ | ' + levelStats.median.toFixed(1) + ' |',
    '| ìµœê³  | ' + levelStats.max + ' |',
    '| p25 / p75 | ' + levelStats.p25.toFixed(1) + ' / ' + levelStats.p75.toFixed(1) + ' |',
  ].join('\n') : '';

  const deathPatternSection = result.deathPattern ? [
    '',
    '## ì‚¬ë§ íŒ¨í„´',
    '',
    '- ì™œë„: ' + result.deathPattern.skewness,
    '- ì²¨ë„: ' + result.deathPattern.kurtosis,
    '- ë¶„í¬: ' + result.deathPattern.cluster,
  ].join('\n') + '\n' : '';

  const suggestionsSection = (result.suggestions?.length > 0)
    ? '## ì œì•ˆ\n\n' + result.suggestions.map(function(s) { return '- ' + s; }).join('\n') + '\n\n'
    : '';

  const lines = [
    '## ' + emoji + ' ' + name + ' â€” Fun Meter ë¦¬í¬íŠ¸ (' + zone + ')',
    '',
    '> ' + runs + 'íšŒ ì‹¤í–‰ Â· ' + new Date().toLocaleString('ko-KR'),
    '',
    '## ìƒì¡´ ì‹œê°„ í†µê³„',
    '',
    '| í•­ëª© | ê°’ |',
    '|------|----|',
    '| í‰ê·  | ' + mean.toFixed(1) + 's |',
    '| ì¤‘ì•™ê°’ | ' + median.toFixed(1) + 's |',
    '| í‘œì¤€í¸ì°¨ | ' + stddev.toFixed(1) + 's |',
    '| p25 / p75 | ' + p25.toFixed(1) + 's / ' + p75.toFixed(1) + 's |',
    '| p90 / p95 | ' + p90.toFixed(1) + 's / ' + p95.toFixed(1) + 's |',
    '| íƒ€ì„ì•„ì›ƒ | ' + (timeoutRate * 100).toFixed(0) + '% |',
    '',
    '## ì ìˆ˜',
    '',
    'í‰ê·  **' + Math.round(scoreMean) + '** Â· ìµœê³  **' + scoreMax + '**',
    levelSection,
    deathPatternSection,
    '## ë¶„í¬ íˆìŠ¤í† ê·¸ë¨',
    '',
    '```',
    histLines,
    '```',
    '',
    '> ğŸ’¡ ' + advice,
    '',
    suggestionsSection,
    '---',
    '_Generated by [radar_fun_meter](https://github.com/on1659/radar_fun_meter)_',
    '',
  ];

  return lines.join('\n');
}

module.exports = { toMarkdown };
